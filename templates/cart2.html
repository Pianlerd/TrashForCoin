{% extends "base.html" %}

{% block title %}จัดการคำสั่งซื้อ - Trash For Coin{% endblock %}

{% block content %}
<section class="bg-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">ตารางเก็บข้อมูลคำสั่งซื้อ</h1>
                <p class="lead mb-4">จัดการคำสั่งซื้อทั้งหมดในระบบ</p>
            </div>
        </div>
    </div>
</section>

<section class="py-4 bg-light">
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% if session.loggedin and session.role in ['root_admin', 'administrator', 'moderator', 'member'] %}

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0 fw-bold"><i class="bi bi-plus-circle me-2"></i>เพิ่มคำสั่งซื้อใหม่</h5>
            </div>
            <form id="addItemForm" method="POST" class="card-body needs-validation" novalidate>
                <input type="hidden" name="action" value="add_manual">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="add_order_id" class="form-label">รหัสคำสั่งซื้อปัจจุบัน</label>
                        <input type="text" class="form-control" id="add_order_id" name="order_id" required readonly 
                               value="{{ current_auto_order_id }}">
                    </div>
                    <div class="col-md-6">
                        <label for="add_email" class="form-label">อีเมลลูกค้า</label>
                        <input type="email" class="form-control" id="add_email" name="email" 
                               value="{{ request_form_data.email if request_form_data.action == 'add_manual' else (session.email if session.role in ['member', 'root_admin', 'administrator', 'moderator'] else '') }}" 
                               {% if session.role == 'member' %}readonly{% endif %} required>
                    </div>

                    <div class="col-md-6">
                        <label for="products_id_input" class="form-label">รหัสสินค้า</label>
                        <input type="text" class="form-control" id="products_id_input" name="products_id_input" 
                               list="productsDatalist" placeholder="พิมพ์หรือสแกนรหัสสินค้า..." required autofocus>
                        <datalist id="productsDatalist">
                            </datalist>
                        <div class="invalid-feedback">กรุณาระบุรหัสสินค้า</div>
                    </div>
                    
                    <input type="hidden" id="raw_products_data_string" value="{{ products_data_string }}">

                    <div class="col-md-6">
                        <label for="selected_product_details_display" class="form-label">สินค้า (ชื่อสินค้า | สต็อก)</label>
                        <input type="text" class="form-control" id="selected_product_details_display" readonly disabled 
                               value="{{ selected_product_details_display }}">
                    </div>

                    <div class="col-md-6">
                        <label for="add_quantity" class="form-label">จำนวน</label>
                        <input type="text" class="form-control" id="add_quantity_display" value="1 (อัตโนมัติ)" readonly disabled>
                        <input type="hidden" name="quantity" value="1"> </div>
                    
                    <input type="hidden" name="disquantity" value="0"> 
                    
                    <div class="col-md-6">
                        <label for="add_barcode_id_hidden" class="form-label">รหัสบาร์โค้ด</label>
                        <input type="text" class="form-control" id="add_barcode_id_hidden" name="barcode_id" readonly 
                               value="{{ selected_product_barcode }}">
                        <div class="form-text">รหัสบาร์โค้ดสำหรับคำสั่งซื้อนี้</div>
                    </div>
                    
                    </div>
            </form>
        </div>

        {# ปุ่ม "เสร็จสิ้น" สำหรับคำสั่งซื้อปัจจุบัน #}
        <div class="text-end mb-4">
            <form method="POST" action="{{ url_for('cart') }}" class="d-inline-block">
                <input type="hidden" name="action" value="complete_order">
                <button type="submit" class="btn btn-warning btn-lg">
                    <i class="bi bi-check-circle me-2"></i>เสร็จสิ้นคำสั่งซื้อนี้
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</section>

<section class="py-4">
    <div class="container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-bold"><i class="bi bi-table me-2"></i>รายการคำสั่งซื้อปัจจุบัน (รหัส: {{ current_auto_order_id }})</h5>
            </div>
            <div class="card-body p-4">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>รหัสคำสั่งซื้อ</th>
                                <th>รหัสสินค้า</th>
                                <th>ชื่อสินค้า</th>
                                <th>บาร์โค้ด</th>
                                <th>จำนวน</th>
                                <th>ทิ้ง</th>
                                <th>อีเมล</th>
                                <th>วันที่</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ order.order_id }}</td> 
                                <td>{{ order.products_id }}</td>
                                <td>{{ order.products_name }}</td>
                                <td>{{ order.barcode_id }}</td> {# แสดงบาร์โค้ดของ order ปัจจุบัน #}
                                <td>{{ order.quantity }}</td>
                                <td>{{ order.disquantity }}</td>
                                <td>{{ order.email }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') if order.order_date else '' }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="9" class="text-center text-muted">ไม่มีข้อมูลในคำสั่งซื้อปัจจุบันนี้</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const productsIdInput = document.getElementById('products_id_input');
        const datalist = document.getElementById('productsDatalist');
        const selectedProductDetailsDisplay = document.getElementById('selected_product_details_display');
        const addBarcodeIdHidden = document.getElementById('add_barcode_id_hidden'); 
        const rawProductsDataString = document.getElementById('raw_products_data_string').value;
        const addItemForm = document.getElementById('addItemForm'); 

        // แปลง string ข้อมูลสินค้าที่ Flask ส่งมา ให้อยู่ในรูปแบบที่ JavaScript เข้าใจง่าย
        const productsMapById = new Map();
        if (rawProductsDataString) {
            const productStrings = rawProductsDataString.split('///'); 
            productStrings.forEach(prodStr => {
                const parts = prodStr.split('|'); 
                if (parts.length === 4) { 
                    const product = {
                        products_id: parts[0],
                        products_name: parts[1],
                        stock: parts[2],
                        barcode_id: parts[3] || '' 
                    };
                    productsMapById.set(product.products_id, product);

                    const option = document.createElement('option');
                    option.value = product.products_id; 
                    option.label = `${product.products_name} (สต็อก: ${product.stock})`; 
                    datalist.appendChild(option);
                }
            });
        }

        // Function to update product details display
        function updateProductDisplay(product) {
            if (product) {
                selectedProductDetailsDisplay.value = `${product.products_name} | สต็อก: ${product.stock}`;
            } else {
                selectedProductDetailsDisplay.value = 'ไม่พบสินค้า';
            }
        }

        // --- Event Listener for Product ID Input (with Datalist) ---
        if (productsIdInput) {
            productsIdInput.addEventListener('input', function() {
                const enteredProductId = this.value.trim();
                const product = productsMapById.get(enteredProductId);
                updateProductDisplay(product);

                // *** ตรวจสอบความยาวและส่งฟอร์มอัตโนมัติ ***
                if (enteredProductId.length === 13) {
                    // ตรวจสอบให้แน่ใจว่า add_barcode_id_hidden มีค่า ก่อนส่งฟอร์ม
                    // ค่านี้ควรถูกตั้งค่าจาก Flask แล้วตั้งแต่ต้น
                    if (!addBarcodeIdHidden.value) {
                         // หาก barcode_id ยังไม่มีค่า (ไม่น่าจะเกิด) อาจจะต้องดึงจาก hidden field หรือ Session Storage
                         // แต่ในกรณีนี้ มันควรจะมาจาก selected_product_barcode ที่ Flask ส่งมาแล้ว
                         console.warn("Barcode ID is empty, but trying to submit. This might lead to issues.");
                         // อาจจะเพิ่ม logic ดึงค่าจาก element ที่ถูกส่งมาจาก Flask อีกที
                         // addBarcodeIdHidden.value = document.getElementById('add_barcode_id_hidden').getAttribute('value');
                    }

                    // ล้างข้อความ validation เก่า (ถ้ามี)
                    productsIdInput.setCustomValidity(''); 
                    addItemForm.classList.remove('was-validated');

                    // ตรวจสอบความถูกต้องของฟอร์ม (โดยเฉพาะช่อง email) ก่อนส่งอัตโนมัติ
                    if (addItemForm.checkValidity()) {
                        // ส่งฟอร์ม
                        addItemForm.submit();
                    } else {
                        // ถ้าฟอร์มไม่สมบูรณ์ (เช่น email ว่าง), แสดงข้อความ validation ของ Bootstrap
                        addItemForm.classList.add('was-validated'); 
                    }
                }
            });

            // Initial load: If pre_filled_products_id_input is set (from Flask after POST)
            const initialEnteredProductId = productsIdInput.value.trim();
            if (initialEnteredProductId) {
                const product = productsMapById.get(initialEnteredProductId);
                updateProductDisplay(product);
            } else {
                 selectedProductDetailsDisplay.value = 'จะแสดงที่นี่หลังจากระบุรหัสสินค้า';
            }
            
            // ตั้งค่า focus ให้กับ input รหัสสินค้าเมื่อหน้าโหลดเสร็จ
            productsIdInput.focus();
        }

        // Bootstrap validation (ยังคงอยู่เผื่อมี field อื่นๆ ที่ต้อง validate)
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        // ไม่ต้องตรวจสอบ productsIdInput ใน submit event แล้ว
                        // เพราะการ submit เกิดจาก JS event listener ของ productsIdInput แล้ว
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
        })();
    });
</script>
{% endblock %}